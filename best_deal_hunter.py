import requests
from bs4 import BeautifulSoup
import pandas as pd
from docx import Document
from docx.shared import Pt, RGBColor
from datetime import datetime

print("ğŸš€ çˆ†æ¬¾æŒ–æ˜æœºå¯åŠ¨...")

# 1. å®šä¹‰è¯„åˆ†ç¿»è¯‘å­—å…¸ (æŠŠè‹±æ–‡å˜æˆæ•°å­—)
rating_map = {
    "One": 1, "Two": 2, "Three": 3, "Four": 4, "Five": 5
}

# å­˜å‚¨æ‰¾åˆ°çš„â€œé»„é‡‘ä¹¦â€
golden_books = []

# 2. æ‰«æå‰ 10 é¡µ (æ¨¡æ‹Ÿå…¨ç«™æ‰«æ)
for page in range(1, 11):
    url = f"http://books.toscrape.com/catalogue/page-{page}.html"
    print(f"ğŸ“¡ æ­£åœ¨æ‰«æç¬¬ {page} é¡µ...")
    
    response = requests.get(url)
    soup = BeautifulSoup(response.text, "html.parser")
    books = soup.find_all("article", class_="product_pod")
    
    for book in books:
        # --- A. è·å–è¯„åˆ† ---
        # è¯„åˆ†è—åœ¨ class å±æ€§é‡Œï¼Œä¾‹å¦‚: class="star-rating Five"
        # æˆ‘ä»¬å–ç¬¬ 2 ä¸ªè¯ 'Five'
        star_class = book.find("p", class_="star-rating")["class"][1]
        rating = rating_map.get(star_class, 0) # æŸ¥å­—å…¸å˜æˆæ•°å­—
        
        # --- B. è·å–ä»·æ ¼ ---
        price_text = book.find("p", class_="price_color").text
        # å»æ‰ 'Â£' å¹¶è½¬ä¸ºå°æ•°
        price = float(price_text.replace("Â£", "").replace("Ã‚", ""))
        
        # --- C. æ ¸å¿ƒç­›é€‰é€»è¾‘ (å•†ä¸šä»·å€¼æ‰€åœ¨) ---
        # å®¢æˆ·è¦æ±‚ï¼š5æ˜Ÿ ä¸” ä»·æ ¼å°äº 20
        if rating == 5 and price < 20:
            title = book.h3.a["title"]
            print(f"   ğŸ’° å‘ç°çˆ†æ¬¾: {title} (Â£{price})")
            
            golden_books.append({
                "ä¹¦å": title,
                "ä»·æ ¼": price,
                "è¯„åˆ†": "â­â­â­â­â­"
            })

print("-" * 30)
print(f"ğŸ‰ æ‰«æç»“æŸï¼å…±æ‰¾åˆ° {len(golden_books)} æœ¬é»„é‡‘ä¹¦ç±ã€‚")

# 3. ç”Ÿæˆ Word é‡‡è´­æŠ¥å‘Š (äº¤ä»˜ç‰©)
print("ğŸ“ æ­£åœ¨ç”Ÿæˆé‡‡è´­æ¸…å•...")

doc = Document()
doc.add_heading('Best Value Books Report', 0)
doc.add_paragraph(f"Generated by: Yang's Bot | Date: {datetime.now().strftime('%Y-%m-%d')}")
doc.add_paragraph(f"Criteria: 5-Star Rating & Price < Â£20")

# --- åœ¨ Word é‡Œç”»è¡¨æ ¼ ---
# åˆ›å»ºä¸€ä¸ªè¡¨ï¼šè¡Œæ•°=ä¹¦ç±æ•°é‡+1(è¡¨å¤´)ï¼Œåˆ—æ•°=3
table = doc.add_table(rows=1, cols=3)
table.style = 'Table Grid' # ç»™è¡¨æ ¼åŠ è¾¹æ¡†

# è®¾ç½®è¡¨å¤´
hdr_cells = table.rows[0].cells
hdr_cells[0].text = 'Book Title'
hdr_cells[1].text = 'Price (Â£)'
hdr_cells[2].text = 'Rating'

# å¡«å…¥æ•°æ®
for item in golden_books:
    row_cells = table.add_row().cells
    row_cells[0].text = item['ä¹¦å']
    row_cells[1].text = str(item['ä»·æ ¼'])
    row_cells[2].text = item['è¯„åˆ†']

# ä¿å­˜
filename = "Golden_Books_Purchase_List.docx"
doc.save(filename)

print(f"âœ… äº¤ä»˜æ–‡ä»¶å·²å°±ç»ª: [{filename}]")
print("è¿™å• $60 èµšåˆ°æ‰‹äº†ï¼å¿«å»æ‰“å¼€çœ‹çœ‹ï¼")